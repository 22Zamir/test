# Keitaro Campaign Manager

Django 5 приложение для управления кампаниями в рекламном трекере Keitaro.

## Возможности

1. **Создание кампаний** - автоматическое создание кампаний с двумя потоками:
   - Flow 1: Пользователи из указанной страны → редирект на Google
   - Flow 2: Остальные пользователи → редирект на выбранный оффер
   - Автоматическая синхронизация с Keitaro API

2. **Управление кампаниями**:
   - Просмотр списка активных кампаний (синхронизируется с Keitaro)
   - Просмотр истории удаленных кампаний
   - Детальная информация о кампании
   - Редактирование кампаний

3. **Управление офферами**:
   - Добавление офферов в кампанию с указанием веса
   - Удаление офферов из кампании (с возможностью восстановления)
   - Просмотр всех офферов кампании
   - Офферы могут быть добавлены без привязки к потоку

4. **Управление потоками (Flows)**:
   - Создание новых потоков (фильтр по стране или редирект на офферы)
   - Удаление потоков из Keitaro и локальной БД
   - Автоматическая синхронизация потоков из Keitaro API
   - Просмотр информации о потоках

5. **Синхронизация с Keitaro**:
   - Автоматическая синхронизация активных кампаний
   - Синхронизация потоков при просмотре/редактировании кампании
   - Обработка ошибок API с подробным логированием

## Установка

1. Клонируйте репозиторий:
```bash
git clone <repository-url>
cd keitaro-campaign-manager
```

2. Создайте виртуальное окружение:
```bash
python -m venv venv
source venv/bin/activate  # Linux/Mac
# или
venv\Scripts\activate  # Windows
```

3. Установите зависимости:
```bash
pip install -r requirements.txt
```

4. Создайте файл `.env` на основе `.env.example`:
```bash
cp .env.example .env
```

5. Заполните настройки в `.env`:
```env
SECRET_KEY=your-secret-key-here
KEITARO_API_URL=https://your-keitaro-instance.com/admin_api/v1
KEITARO_API_KEY=your-api-key-here

# Опциональные настройки (можно оставить пустыми)
KEITARO_DOMAIN=
KEITARO_GROUP=
KEITARO_SOURCE=
```

**Важно:** 
- `KEITARO_API_URL` должен включать путь `/admin_api/v1` (например, `https://your-keitaro-instance.com/admin_api/v1`)
- Поля `KEITARO_DOMAIN`, `KEITARO_GROUP` и `KEITARO_SOURCE` опциональны
- Если они не указаны в `.env`, вы сможете указать их при создании кампании через веб-интерфейс

**Где взять API ключ:**
1. Войдите в админку Keitaro
2. Перейдите в "Профиль" → "API ключи"
3. Скопируйте существующий ключ или создайте новый
4. Убедитесь, что ключ имеет права на управление кампаниями, потоками и офферами

6. Выполните миграции:
```bash
python manage.py migrate
```

7. Создайте суперпользователя (опционально):
```bash
python manage.py createsuperuser
```

8. Запустите сервер разработки:
```bash
python manage.py runserver
```

## Использование

### Создание кампании

1. Перейдите на страницу "Создать кампанию"
2. Заполните форму:
   - **Название кампании**: любое имя для идентификации
   - **Geo**: код страны (например, AU, MX, RO)
   - **Offer ID**: ID оффера из Keitaro
3. Нажмите "Создать"

Система автоматически создаст:
- Кампанию в Keitaro с указанными настройками
- Два потока (flows) согласно требованиям
- Записи в локальной базе данных

### Просмотр кампании

1. Откройте кампанию из списка
2. Просмотрите детальную информацию:
   - Основные параметры кампании
   - Список потоков
   - Список активных офферов
3. Нажмите "Редактировать" для внесения изменений

### Редактирование кампании

1. Откройте кампанию из списка и нажмите "Редактировать"
2. **Добавление офферов:**
   - Используйте форму слева "Добавить оффер"
   - Укажите ID оффера и вес (по умолчанию 1)
   - Оффер будет добавлен в кампанию без привязки к потоку
3. **Удаление офферов:**
   - Используйте кнопку "Удалить" в таблице офферов
   - Оффер будет помечен как удаленный и скрыт из списка
   - Удаленные офферы можно восстановить, добавив их снова
4. **Создание потоков:**
   - Используйте форму "Создать поток"
   - Выберите тип потока:
     - **Фильтр по стране** - редирект на указанный URL для пользователей из определенной страны
     - **Редирект на оффер(ы)** - редирект на один или несколько офферов
   - Система автоматически синхронизирует поток с Keitaro
5. **Удаление потоков:**
   - Используйте кнопку "Удалить" в таблице потоков
   - Поток будет удален из Keitaro и локальной БД

### История кампаний

1. Перейдите в раздел "История" в меню
2. Просмотрите список удаленных кампаний
3. Увидите кампании, которые были удалены в Keitaro, но остались в локальной БД

## Структура проекта

```
keitaro-campaign-manager/
├── campaigns/          # Основное приложение
│   ├── models.py       # Модели данных
│   ├── views.py        # Представления
│   ├── forms.py        # Формы
│   ├── services.py     # Бизнес-логика
│   ├── keitaro_api.py  # Клиент Keitaro API
│   └── urls.py         # URL маршруты
├── keitaro_tracker/    # Настройки проекта
├── templates/          # HTML шаблоны
├── static/             # Статические файлы
└── manage.py          # Django управляющий скрипт
```

## API Keitaro

Приложение использует Keitaro Admin API для:
- Создания и обновления кампаний
- Получения списка активных и удаленных кампаний
- Управления потоками (streams): создание, обновление, удаление
- Получения информации об офферах
- Синхронизации данных между локальной БД и Keitaro

**Особенности работы с API:**
- Автоматическая обработка ошибок API (500, 401, 422)
- Повторные попытки создания потоков с разными параметрами
- Подробное логирование всех запросов и ответов
- Кэширование схем и действий для оптимизации

Документация API доступна в админке Keitaro в разделе "Профиль" → "API ключи" → "Документация".

## Логирование

Приложение ведет подробные логи всех операций:
- Логи записываются в файл `django.log` в корне проекта
- Логи также выводятся в консоль Django
- Уровни логирования:
  - `DEBUG` - детальная информация о запросах к API
  - `INFO` - основные операции (создание, обновление, удаление)
  - `WARNING` - предупреждения (ошибки API, которые не критичны)
  - `ERROR` - критические ошибки

**Просмотр логов:**
```bash
# Последние 50 строк
tail -n 50 django.log

# Windows PowerShell
Get-Content django.log -Tail 50

# Поиск по ключевым словам
Get-Content django.log -Tail 100 | Select-String -Pattern "оффер|offer|error"
```

## Особенности реализации

### Синхронизация данных
- Автоматическая синхронизация активных кампаний при загрузке списка
- Синхронизация потоков при просмотре/редактировании кампании
- Удаленные офферы не восстанавливаются автоматически при синхронизации
- Офферы без потока (`flow=None`) не помечаются как удаленные при синхронизации

### Управление офферами
- Офферы могут быть добавлены в кампанию без привязки к потоку
- Удаленные офферы помечаются как `removed`, но остаются в БД
- При повторном добавлении удаленного оффера он автоматически восстанавливается
- Офферы фильтруются по статусу `active` при отображении

### Обработка ошибок
- Обработка ошибок 500 от Keitaro API (иногда операции успешны, несмотря на ошибку)
- Повторные попытки создания потоков с разными параметрами
- Подробные сообщения об ошибках для пользователя
- Логирование всех ошибок для отладки

## Структура базы данных

### Campaign (Кампания)
- `keitaro_id` - ID кампании в Keitaro
- `name` - название кампании
- `geo` - код страны
- `offer_id` - ID основного оффера
- `domain`, `group`, `source` - дополнительные параметры

### Flow (Поток)
- `keitaro_id` - ID потока в Keitaro
- `campaign` - связь с кампанией
- `name` - название потока
- `flow_type` - тип потока (`country_filter` или `offer_redirect`)
- `country` - код страны для фильтра
- `redirect_url` - URL для редиректа

### CampaignOffer (Оффер кампании)
- `campaign` - связь с кампанией
- `flow` - связь с потоком (может быть `None`)
- `offer_id` - ID оффера в Keitaro
- `offer_name` - название оффера
- `weight` - вес оффера для ротации
- `status` - статус (`active` или `removed`)

## Технологии

- **Django 5.0.1** - веб-фреймворк
- **Python 3.8+** - язык программирования
- **Bootstrap 5.3** - CSS фреймворк для UI
- **Requests** - библиотека для работы с HTTP API
- **python-dotenv** - загрузка переменных окружения из `.env`

## Разработка

### Запуск в режиме разработки
```bash
python manage.py runserver
```

### Применение миграций
```bash
python manage.py makemigrations
python manage.py migrate
```

### Создание суперпользователя
```bash
python manage.py createsuperuser
```

### Просмотр логов
```bash
# Linux/Mac
tail -f django.log

# Windows PowerShell
Get-Content django.log -Wait -Tail 50
```

## Безопасность

- API ключи хранятся в переменных окружения (файл `.env`)
- Файл `.env` добавлен в `.gitignore` и не попадает в репозиторий
- Используется Django CSRF защита для всех форм
- Логи не содержат чувствительных данных

## Известные ограничения

1. API ключ должен иметь права на управление кампаниями, потоками и офферами
2. Некоторые операции в Keitaro API могут возвращать ошибку 500, но при этом быть успешными
3. Офферы без потока не синхронизируются с Keitaro (они существуют только локально)

## Лицензия

Проект создан в рамках тестового задания.

